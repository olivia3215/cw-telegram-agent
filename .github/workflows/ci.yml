name: CI

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
  workflow_dispatch:

# needed so the workflow can write PR comments on same-repo PRs
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # python-version: ["3.12", "3.13"]
        python-version: ["3.13"]

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: test_cindy_agent
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-asyncio anyio telethon pytest-cov

      - name: Prepare state dir
        run: mkdir -p state/media

      - name: Set up MySQL test database
        env:
          CINDY_AGENT_MYSQL_TEST_HOST: 127.0.0.1
          CINDY_AGENT_MYSQL_TEST_PORT: 3306
          CINDY_AGENT_MYSQL_TEST_DATABASE: test_cindy_agent
          CINDY_AGENT_MYSQL_TEST_USER: root
          CINDY_AGENT_MYSQL_TEST_PASSWORD: rootpassword
        run: |
          # Wait for MySQL to be ready using Python
          python - <<'PY'
          import time
          import pymysql
          max_attempts = 30
          for i in range(max_attempts):
              try:
                  # First try connecting without database (MySQL service might still be initializing)
                  conn = pymysql.connect(
                      host='127.0.0.1',
                      port=3306,
                      user='root',
                      password='rootpassword'
                  )
                  conn.close()
                  # Then try with database
                  conn = pymysql.connect(
                      host='127.0.0.1',
                      port=3306,
                      user='root',
                      password='rootpassword',
                      database='test_cindy_agent'
                  )
                  conn.close()
                  print("MySQL is ready!")
                  break
              except Exception as e:
                  if i == max_attempts - 1:
                      raise RuntimeError(f"MySQL not ready after {max_attempts} attempts: {e}")
                  print(f"Waiting for MySQL... (attempt {i+1}/{max_attempts})")
                  time.sleep(2)
          PY
          # Create schema
          PYTHONPATH=src python scripts/create_mysql_schema.py

      - name: Run tests (with coverage)
        env:
          PYTHONPATH: .
          CINDY_AGENT_STATE_DIR: state
          CINDY_AGENT_MYSQL_TEST_HOST: 127.0.0.1
          CINDY_AGENT_MYSQL_TEST_PORT: 3306
          CINDY_AGENT_MYSQL_TEST_DATABASE: test_cindy_agent
          CINDY_AGENT_MYSQL_TEST_USER: root
          CINDY_AGENT_MYSQL_TEST_PASSWORD: rootpassword
        run: |
          pytest -vv -s --cov=. --cov-report=term-missing:skip-covered --cov-report=xml

      - name: Extract coverage percent
        id: cov
        run: |
          python - <<'PY'
          import os, xml.etree.ElementTree as ET
          root = ET.parse('coverage.xml').getroot()
          pct = None
          if 'line-rate' in root.attrib:
              pct = float(root.attrib['line-rate']) * 100.0
          else:
              lines_valid = int(root.attrib.get('lines-valid', 0))
              lines_covered = int(root.attrib.get('lines-covered', 0))
              pct = (lines_covered / lines_valid * 100.0) if lines_valid else 0.0
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"coverage_pct={pct:.2f}\n")
          PY

      # Show coverage in the job summary (works for fork PRs too)
      - name: Post coverage to job summary
        if: always()
        run: |
          {
            echo "### Test coverage"
            echo
            echo "${{ steps.cov.outputs.coverage_pct }}%"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: coverage.xml

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- COVERAGE-REPORT -->';
            const pct = `${{ steps.cov.outputs.coverage_pct }}`;
            const body = `${marker}
            **Test coverage:** ${pct}%`;
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number });
            const existing = comments.find(c => c.body && c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }
